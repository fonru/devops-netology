# Задача 1

> напишите список операций, которые вы будете производить для остановки запроса пользователя

1) Найдем сперва запросы которые выполняются больше 3х секунд.

```shell
db.currentOp(
   {
     "active" : true,
     "secs_running" : { "$gt" : 3 },
     "ns" : /^db1\./
   }
)
```

2) Кильнем нужные запросы

```shell
db.killOp(<opid of the query to kill>))
```


>Предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB

```text
- создание индексов
- оптимизация запросов
```

# Задача 2

>Перед выполнением задания познакомьтесь с документацией по Redis latency troobleshooting.\
Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. \
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и увеличивается пропорционально количеству реплик сервиса.\
При масштабировании сервиса до N реплик вы увидели, что:\
сначала рост отношения записанных значений к истекшим\
Redis блокирует операции записи\
Как вы думаете, в чем может быть проблема?

```text
Redis удаляет ключи с истекшим сроком действия двумя способами:
- Lazy - истекает срок действия ключа, когда он запрашивается командой, но оказывается, что срок его действия уже истек.
- Active -  истекает через несколько ключей каждые 100 миллисекунд.
Активный способ преполагает, что  ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP = 20 и выполняется процесс 10 раз в секунду.
Получается в секунду может быть удалено 200 клюей. Исходя из этого получаем, что если Редис блокирует запись, то база
переполняется ключами и необходимо увеличить параметр ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP. (если я все правильно понял)
```

# Задача 3

>Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы, пользователи начали жаловаться на ошибки вида:\
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
Как вы думаете, почему это начало происходить и как локализовать проблему?\
Какие пути решения данной проблемы вы можете предложить?

```text
- снифим траффик и дебежим с wireshark 
- поизучать log_error
- увеличить connect_timeout
- если в запросе есть blob данные (обычно сопровождается ошибкой типа ER_NET_PACKET_TOO_LARGE)
то можно попробовать увеличить max_allowed_packet 
```

# Задача 4

> Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с большим объемом данных лучше, чем MySQL.\
После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:\
postmaster invoked oom-killer\
Как вы думаете, что происходит?\
Как бы вы решили данную проблему?

```text
- Увеличить ram и swap
- В настройках PG произвести оптимизацию параметров shared_buffers, maintenance_work_mem, work_mem, effective_cache_size
- Отключить ООМ, но это неправильный подход
```